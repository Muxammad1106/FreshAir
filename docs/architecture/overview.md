# Архитектура системы FreshAir

## Обзор

FreshAir построена на основе архитектуры "клиент-сервер" с четким разделением между frontend и backend компонентами.

## Общая архитектура

```
┌─────────────────┐
│   Frontend      │
│   (React)       │
│   airly.life    │
└────────┬────────┘
         │ HTTPS/REST API
         │
┌────────▼────────┐
│   Backend API   │
│   (Django)      │
│ api.airly.life  │
└────────┬────────┘
         │
    ┌────┴────┬──────────┬──────────┐
    │         │          │          │
┌───▼───┐ ┌──▼───┐ ┌─────▼────┐ ┌──▼────┐
│Postgres│ │Redis │ │  Celery  │ │Nginx  │
│   DB   │ │Cache │ │  Worker  │ │Proxy  │
└────────┘ └──────┘ └──────────┘ └───────┘
```

## Компоненты системы

### 1. Frontend (React)

**Технологии:**
- React 18.2 с TypeScript
- Material-UI для компонентов
- React Router для навигации
- Axios для HTTP запросов

**Структура:**
- `pages/client/` - Страницы для клиентов
- `pages/investor/` - Страницы для инвесторов
- `components/` - Переиспользуемые компоненты
- `layouts/` - Layout компоненты
- `utils/` - Утилиты и хелперы

### 2. Backend (Django)

**Технологии:**
- Django 5.2.8
- Django REST Framework
- PostgreSQL
- Celery + Redis
- Gunicorn

**Модули:**
- `apps/core/` - Основная бизнес-логика
- `apps/users/` - Управление пользователями и аутентификация
- `apps/api/` - API endpoints (legacy)
- `apps/toolkit/` - Общие утилиты

### 3. База данных

**PostgreSQL** используется как основная БД с следующими основными таблицами:
- `users_user` - Пользователи
- `core_customer_profiles` - Профили клиентов
- `core_investor_profiles` - Профили инвесторов
- `core_rooms` - Помещения
- `core_device_types` - Типы устройств
- `core_device_instances` - Экземпляры устройств
- `core_customer_orders` - Заказы клиентов
- `core_payments` - Платежи
- `core_investments` - Инвестиции

### 4. Очереди задач

**Celery** используется для фоновых задач:
- Обработка метрик устройств
- Отправка email уведомлений
- Периодические задачи (через Celery Beat)

## Потоки данных

### Customer Flow (Клиент)

1. Регистрация/Вход → Создание профиля Customer
2. Добавление помещения (Room)
3. Создание заказа (CustomerOrder) с выбором устройств
4. Оплата заказа → Создание Payment
5. Автоматическое создание DeviceInstance после оплаты
6. Мониторинг устройства и метрик

### Investor Flow (Инвестор)

1. Регистрация/Вход → Создание профиля Investor
2. Просмотр доступных устройств для инвестиций
3. Создание Investment
4. Подтверждение оплаты инвестиции
5. Получение прибыли на основе метрик устройства
6. Мониторинг портфолио

## API Архитектура

### RESTful API

Все API endpoints следуют RESTful принципам:

```
/api/v1/
├── users/          # Управление пользователями
│   ├── auth/login
│   ├── auth/register
│   └── me
├── core/
│   ├── customer/   # Endpoints для клиентов
│   │   ├── rooms
│   │   ├── orders
│   │   ├── devices
│   │   ├── payment-cards
│   │   └── payments
│   └── investor/   # Endpoints для инвесторов
│       ├── dashboard
│       ├── investments
│       └── devices/available
└── toolkit/        # Swagger документация
```

### Аутентификация

Используется Token-based аутентификация:
- При логине создается токен (JWT)
- Токен передается в заголовке `Authorization: Token <token>`
- Токены имеют срок действия (по умолчанию 7200 секунд)

## Безопасность

1. **Аутентификация**: Token-based через Django REST Framework
2. **Авторизация**: Проверка прав доступа на уровне views
3. **CORS**: Настроен только для разрешенных доменов
4. **Валидация**: Все входные данные валидируются через сериализаторы
5. **SQL Injection**: Защита через Django ORM
6. **XSS**: Защита через React и Django templates

## Производительность

1. **Оптимизация запросов**: Использование `select_related` и `prefetch_related`
2. **Пагинация**: Все списки пагинируются (по умолчанию 50 элементов)
3. **Кэширование**: Redis для кэширования сессий и результатов Celery
4. **Статические файлы**: Обслуживаются через Nginx

## Масштабируемость

1. **Горизонтальное масштабирование**: Можно запустить несколько инстансов backend
2. **База данных**: PostgreSQL поддерживает репликацию
3. **Очереди**: Celery workers можно масштабировать независимо
4. **Frontend**: Статические файлы можно раздавать через CDN

## Мониторинг

1. **Логи**: Логирование через Django logging
2. **Метрики устройств**: Хранятся в `core_device_metrics`
3. **Health checks**: Endpoints для проверки здоровья сервисов

## Развертывание

См. [Deployment Guide](../deployment/production.md) для деталей развертывания.

